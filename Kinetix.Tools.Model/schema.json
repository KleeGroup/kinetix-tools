{
  "$id": "modgen.json",
  "$schema": "http://json-schema.org/draft-07/schema#",
  "oneOf": [
    {
      "type": "object",
      "description": "Définition d'un fichier.",
      "required": [ "app", "module", "kind", "file" ],
      "additionalProperties": false,
      "properties": {
        "app": {
          "type": "string",
          "description": "Nom de l'application."
        },
        "module": {
          "type": "string",
          "description": "Nom du module contenant ce fichier."
        },
        "kind": {
          "type": "string",
          "description": "Catégorie de fichier, pour déterminer quels générateurs doivent lire tel fichier."
        },
        "file": {
          "type": "string",
          "description": "Nom du fichier courant."
        },
        "uses": {
          "type": "array",
          "description": "Dépendances du fichier courant. Il est nécessaire de spécifier l'intégralité des fichiers existants utilisés dans de fichier, et d'en lister toutes les classes référencées.",
          "items": {
            "type": "object",
            "description": "Détail d'une dépendance.",
            "required": [ "module", "kind", "files" ],
            "additionalProperties": false,
            "properties": {
              "module": {
                "type": "string",
                "description": "Nom du module référencé."
              },
              "kind": {
                "type": "string",
                "description": "Data (persistant) ou Metier (DTOs).",
                "enum": [ "Data", "Metier" ]
              },
              "files": {
                "type": "array",
                "description": "Liste des fichiers du module à référencer.",
                "items": {
                  "type": "string",
                  "description": "Nom du fichier référencé."
                }
              }
            }
          }
        }
      }
    },
    {
      "type": "object",
      "description": "Définition d'un domaine.",
      "required": [ "domain" ],
      "additionalProperties": false,
      "properties": {
        "domain": {
          "type": "object",
          "description": "Domaine.",
          "required": [ "name", "label", "csharpType" ],
          "additionalProperties": false,
          "properties": {
            "name": {
              "type": "string",
              "description": "Nom (ou code) du domaine."
            },
            "label": {
              "type": "string",
              "description": "Libellé du domaine."
            },
            "csharpType": {
              "type": "string",
              "description": "Type correspondant au domaine en C#. Sera utilisé pour déterminer le type TS."
            },
            "sqlType": {
              "type": "string",
              "description": "Type correspondant au domaine en SQL. Si le domaine n'est jamais lié à une donnée persistée alors il n'a pas besoin de type SQL."
            },
            "customAnnotation": {
              "type": "string",
              "description": "Annotation à ajouter sur toutes les propriétés C# de ce domaine (par exemple pour aider l'ORM a mapper le type correctement)."
            },
            "customUsings": {
              "type": "string",
              "description": "Usings, séparés par des virgules, à ajouter à toute classe C# qui possède une propriété de ce domaine. Par exemple pour ajouter un using pour des types de collections."
            },
            "useTypeName": {
              "type": "boolean",
              "description": "Ajoute la propriété 'TypeName' dans l'annotation 'Column' en C# pour préciser le type SQL."
            }
          }
        }
      }
    },
    {
      "type": "object",
      "description": "Définition d'une classe.",
      "required": [ "class" ],
      "additionalProperties": false,
      "properties": {
        "class": {
          "type": "object",
          "description": "Définition d'une classe.",
          "required": [ "name", "comment", "properties" ],
          "additionalProperties": false,
          "properties": {
            "trigram": {
              "type": "string",
              "description": "Le trigramme qui préfixera toutes les propriétés de la classe en SQL. Doit faire exactement 3 lettres.",
              "minLength": 3,
              "maxLength": 3
            },
            "name": {
              "type": "string",
              "description": "Nom C#/TS de la classe. Sera converti en SQL en SNAKE_CASE."
            },
            "sqlName": {
              "type": "string",
              "description": "Nom SQL de la classe. Sera généré à partir du nom standard si non renseigné."
            },
            "extends": {
              "type": "string",
              "description": "Nom de la classe parente de cette classe. Doit être référencée dans ce fichier, soit en y étant déclarée, soit en étant listée dans la section 'uses' du fichier."
            },
            "label": {
              "type": "string",
              "description": "Un libellé qui décrit la classe. N'est utilisé nulle part."
            },
            "reference": {
              "type": "boolean",
              "description": "Précise si la classe est une liste de référence (pour mise en cache dans 'ReferenceManager' ou 'referenceStore'."
            },
            "defaultProperty": {
              "type": "string",
              "description": "Nom de la propriété de la classe qui sera utilisée comme libellé pour les listes de référence. Si non renseignée, la propriété 'Libelle' sera utilisée (en espérant qu'elle existe)."
            },
            "orderProperty": {
              "type": "string",
              "description": "Nom de la propriété de la classe qui sera utilisée pour trier la liste de référence. Si non renseignée, le tri par défaut de la base de données sera utilisé (par clé primaire, ordre d'insertion...)."
            },
            "flagProperty": {
              "type": "string",
              "description": "Nom de la propriété de la classe qui sera utilisée comme flag binaire, en plus du code dans une liste de référence statique."
            },
            "comment": {
              "type": "string",
              "description": "Description de la classe."
            },
            "properties": {
              "type": "array",
              "description": "Liste des propriétés de la classe. Cette propriété DOIT être en DERNIER (ou juste avant 'values' si renseigné).",
              "items": {
                "oneOf": [
                  {
                    "type": "object",
                    "description": "Propriété standard.",
                    "required": [ "name", "label", "domain", "comment" ],
                    "additionalProperties": false,
                    "properties": {
                      "name": {
                        "type": "string",
                        "description": "Nom de la propriété C#/TS. Sera converti en SQL en TRIGRAM_{{SNAKE_CASE}}. Cette propriété DOIT être en PREMIER."
                      },
                      "label": {
                        "type": "string",
                        "description": "Libellé de la propriété. Sera utilisé comme libellé pour le champ dans Focus."
                      },
                      "primaryKey": {
                        "type": "boolean",
                        "description": "Précise si la propriété est la clé primaire de la table associée à la classe."
                      },
                      "unique": {
                        "type": "boolean",
                        "description": "Précise si la propriété possède une contrainte d'unicité (utile si ce n'est pas une clé primaire). Doit être renseigné pour une classe de référence non statique."
                      },
                      "required": {
                        "type": "boolean",
                        "description": "Précise si la propriété est obligatoire. Elle sera non nulle en SQL et obligatoire dans la validation côté Focus. Une primary key est forcément required."
                      },
                      "domain": {
                        "type": "string",
                        "description": "Le domaine lié à la propriété. Doit référencer un domaine défini dans le fichier de domaines."
                      },
                      "comment": {
                        "type": "string",
                        "description": "Description de la propriété."
                      },
                      "defaultValue": {
                        "type": [ "string", "number", "boolean" ],
                        "description": "Valeur par défaut de la propriété, dans la base de données."
                      }
                    }
                  },
                  {
                    "type": "object",
                    "description": "Propriété d'association (clé étrangère).",
                    "required": [ "association", "label", "comment" ],
                    "additionalProperties": false,
                    "properties": {
                      "association": {
                        "type": "string",
                        "description": "Nom de la classe référencée par cette propriété. Doit être référencée dans ce fichier, soit en y étant déclarée, soit en étant listée dans la section 'uses' du fichier. Cette propriété DOIT être en PREMIER."
                      },
                      "label": {
                        "type": "string",
                        "description": "Libellé de la propriété. Sera utilisé comme libellé pour le champ dans Focus."
                      },
                      "role": {
                        "type": "string",
                        "description": "Suffixe de l'association, utile pour distinguer deux associations vers une même classe par exemple."
                      },
                      "required": {
                        "type": "boolean",
                        "description": "Précise si la propriété est obligatoire. Elle sera non nulle en SQL et obligatoire dans la validation côté Focus. Une primary key est forcément required."
                      },
                      "defaultValue": {
                        "type": [ "string", "number", "boolean" ],
                        "description": "Valeur par défaut de la propriété, dans la base de données."
                      },
                      "comment": {
                        "type": "string",
                        "description": "Description de la propriété."
                      }
                    }
                  },
                  {
                    "type": "object",
                    "description": "Alias vers un champ existant.",
                    "required": [ "alias" ],
                    "additionalProperties": false,
                    "properties": {
                      "alias": {
                        "type": "object",
                        "description": "Définition de la propriété aliasée. Cette propriété DOIT être en PREMIER.",
                        "required": [ "property", "class" ],
                        "additionalProperties": false,
                        "properties": {
                          "property": {
                            "oneOf": [
                              {
                                "type": "string",
                                "description": "Propriété de l'alias. Elle doit être définie sur la classe cible."
                              },
                              {
                                "type": "array",
                                "description": "Liste des propriétés à aliaser.",
                                "items": {
                                  "type": "string",
                                  "description": "Propriété de l'alias. Elle doit être définie sur la classe cible.."
                                }
                              }
                            ]
                          },
                          "class": {
                            "type": "string",
                            "description": "Nom de la classe comportant la propriété aliasée. Doit être référencée dans ce fichier, soit en y étant déclarée, soit en étant listée dans la section 'uses' du fichier."
                          }
                        }
                      },
                      "prefix": {
                        "oneOf": [
                          {
                            "type": "string",
                            "description": "Préfixe à ajouter au nom de la propriété aliasée."
                          },
                          {
                            "type": "boolean",
                            "description": "Ajoute le nom de la classe comme préfixe au nom de la propriété aliasée."
                          }
                        ]
                      },
                      "suffix": {
                        "oneOf": [
                          {
                            "type": "string",
                            "description": "Suffixe à ajouter au nom de la propriété aliasée."
                          },
                          {
                            "type": "boolean",
                            "description": "Ajoute le nom de la classe comme suffixe au nom de la propriété aliasée."
                          }
                        ]
                      },
                      "label": {
                        "type": "string",
                        "description": "Surcharge le libellé de la propriété aliasée."
                      },
                      "required": {
                        "type": "boolean",
                        "description": "Surcharge le caractère obligatoire de la propriété aliasée."
                      }
                    }
                  },
                  {
                    "type": "object",
                    "description": "Propriété de composition d'une sous classe ou d'une sous liste de classe. Ne peut être utilisé que dans les modules métier.",
                    "required": [ "composition", "name", "kind", "comment" ],
                    "additionalProperties": false,
                    "properties": {
                      "composition": {
                        "type": "string",
                        "description": "Nom de la classe à composer. Doit être référencée dans ce fichier, soit en y étant déclarée, soit en étant listée dans la section 'uses' du fichier. Cette propriété DOIT être en PREMIER."
                      },
                      "name": {
                        "type": "string",
                        "description": "Nom de la propriété."
                      },
                      "kind": {
                        "type": "string",
                        "description": "'object' ou 'list', respectivement pour un sous objet et une sous liste.",
                        "enum": [ "object", "list" ]
                      },
                      "comment": {
                        "type": "string",
                        "description": "Description de la propriété."
                      }
                    }
                  }
                ]
              }
            },
            "values": {
              "type": "object",
              "description": "Liste des valeurs de la table à insérer à la création de la base de données. DOIT être placé en DERNIER. Il doit d'agir d'un objet ayant pour clés un nom de ligne (qui sera utilisé pour identifier la clé en C#), et pour valeurs un objet de type JSON qui renseigne les valeurs des différentes propriétés."
            }
          }
        }
      }
    }
  ]
}
